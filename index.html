<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT ì—°ë™ JSON to Excel ë³€í™˜ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .settings {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
        }
        
        .settings h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .setting-item {
            margin-bottom: 15px;
        }
        
        .setting-item:last-child {
            margin-bottom: 0;
        }
        
        label {
            display: block;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        input[type="text"], input[type="number"], input[type="password"], textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="number"]:focus, input[type="password"]:focus, textarea:focus {
            border-color: #667eea;
            outline: none;
        }
        
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9ff;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }
        
        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8eaff;
            transform: scale(1.02);
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .convert-btn {
            background: linear-gradient(135deg, #764ba2, #667eea);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .convert-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(118, 75, 162, 0.3);
        }
        
        .convert-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .loading {
            display: none;
            text-align: center;
            color: #667eea;
            font-weight: bold;
            background: #f0f1ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .download-section {
            margin-top: 20px;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            getDefaultPrompt() {
                return `ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ìƒí’ˆ ì„¤ëª… ì‘ì„±ìì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ìƒí’ˆ ì„¤ëª…ì„ ë‹¤ìŒê³¼ ê°™ì´ ê°œì„ í•´ì£¼ì„¸ìš”:

1. ê³ ê°ì˜ ê´€ì‹¬ì„ ëŒ ìˆ˜ ìˆëŠ” ë§¤ë ¥ì ì¸ ì œëª©ìœ¼ë¡œ ì‹œì‘
2. ìƒí’ˆì˜ ì£¼ìš” íŠ¹ì§•ê³¼ ì¥ì ì„ ëª…í™•í•˜ê²Œ ì„¤ëª…
3. ê³ ê°ì´ êµ¬ë§¤í•˜ê³  ì‹¶ì–´í•˜ëŠ” ê°ì •ì„ ë¶ˆëŸ¬ì¼ìœ¼í‚¤ëŠ” ì„¤ëª…
4. ì „ë¬¸ì ì´ê³  ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” í†¤ìœ¼ë¡œ ì‘ì„±
5. HTML íƒœê·¸ëŠ” ìœ ì§€í•˜ë˜, ê°€ë…ì„±ì„ ë†’ì´ë„ë¡ ì •ë¦¬
6. ìƒí’ˆì˜ í’ˆì§ˆê³¼ ê°€ì¹˜ë¥¼ ê°•ì¡°

ê¸°ì¡´ ë‚´ìš©ì˜ í•µì‹¬ ì •ë³´ëŠ” ìœ ì§€í•˜ë©´ì„œ ë” ë§¤ë ¥ì ì´ê³  íŒë§¤ë ¥ ìˆëŠ” ì„¤ëª…ìœ¼ë¡œ ê°œì„ í•´ì£¼ì„¸ìš”.`;
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f1ff;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .preview {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            display: none;
        }
        
        .preview-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .saved-indicator {
            color: #28a745;
            font-size: 12px;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– GPT ì—°ë™ JSON to Excel ë³€í™˜ê¸°</h1>
        
        <div class="alert" id="alert"></div>
        
        <!-- GPT ì„¤ì • ë° í”„ë¡¬í”„íŠ¸ ì„¤ì • -->
        <div class="settings-grid">
            <div class="settings">
                <h3>ğŸ”‘ GPT API ì„¤ì •</h3>
                <div class="setting-item">
                    <label for="apiKey">OpenAI API Key:</label>
                    <input type="password" id="apiKey" placeholder="sk-..." />
                    <div class="saved-indicator" id="apiKeySaved" style="display: none;">âœ… API Key ì €ì¥ë¨</div>
                </div>
                <button class="btn btn-primary btn-small" onclick="saveApiKey()">ğŸ’¾ API Key ì €ì¥</button>
                <button class="btn btn-success btn-small" onclick="testApiKey()">ğŸ§ª API Key í…ŒìŠ¤íŠ¸</button>
            </div>
            
            <div class="settings">
                <h3>ğŸ“ í”„ë¡¬í”„íŠ¸ ì„¤ì •</h3>
                <div class="setting-item">
                    <label for="gptPrompt">GPT í”„ë¡¬í”„íŠ¸:</label>
                    <textarea id="gptPrompt" placeholder="ìƒí’ˆ ì„¤ëª…ì„ ê°œì„ í•˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    <div class="saved-indicator" id="promptSaved" style="display: none;">âœ… í”„ë¡¬í”„íŠ¸ ì €ì¥ë¨</div>
                </div>
                <button class="btn btn-primary btn-small" onclick="savePrompt()">ğŸ’¾ í”„ë¡¬í”„íŠ¸ ì €ì¥</button>
                <button class="btn btn-success btn-small" onclick="loadDefaultPrompt()">ğŸ”„ ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ ë¡œë“œ</button>
            </div>
        </div>
        
        <!-- ê¸°ë³¸ ë³€í™˜ ì„¤ì • -->
        <div class="settings">
            <h3>âš™ï¸ ë³€í™˜ ì„¤ì •</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div class="setting-item">
                    <label for="marginRate">ì´ìµë¥  (%):</label>
                    <input type="number" id="marginRate" value="40" min="0" max="100" step="0.1" />
                </div>
                <div class="setting-item">
                    <label for="filename">íŒŒì¼ëª…:</label>
                    <input type="text" id="filename" value="products.xlsx" />
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div class="setting-item">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="useGpt" checked style="width: auto;" />
                        <span>ğŸ¤– GPT ì‚¬ìš©</span>
                    </label>
                </div>
                <div class="setting-item">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="skipImageUpload" style="width: auto;" />
                        <span>ğŸš« ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸</span>
                    </label>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn btn-primary btn-small" onclick="clearImageCache()">ğŸ—‘ï¸ ì´ë¯¸ì§€ ìºì‹œ ì‚­ì œ</button>
                <button class="btn btn-success btn-small" onclick="showImageCache()">ğŸ“· ì €ì¥ëœ ì´ë¯¸ì§€ í™•ì¸</button>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: #e8f4fd; border-radius: 8px; border-left: 4px solid #0066cc;">
                <h4 style="margin: 0 0 10px 0; color: #0066cc;">ğŸ“· ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜µì…˜</h4>
                <div style="font-size: 13px; color: #0066cc; line-height: 1.5;">
                    <p style="margin: 0 0 8px 0;"><strong>âœ… ì´ë¯¸ì§€ ì—…ë¡œë“œ (ê¸°ë³¸):</strong> ì›ë³¸ ì´ë¯¸ì§€ë¥¼ ì´ë¯¸ì§€BBì— ì—…ë¡œë“œí•˜ì—¬ ì•ˆì •ì ì¸ ë§í¬ ìƒì„±</p>
                    <p style="margin: 0;"><strong>ğŸš« ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸:</strong> ì´ë¯¸ ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ ì´ë¯¸ì§€BBì—ì„œ ì°¾ì•„ì„œ ë§¤ì¹­ (ë¹ ë¥¸ ë³€í™˜)</p>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 12px; color: #856404;">
                ğŸ’¡ <strong>GPT ì‚¬ìš© ì‹œ ì£¼ì˜ì‚¬í•­:</strong><br>
                â€¢ ìƒí’ˆëª…, ê¸°ë³¸ì„¤ëª…, ìƒí’ˆì„¤ëª…ì´ ëª¨ë‘ ê°œì„ ë˜ì–´ API ë¹„ìš©ì´ ì¦ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                â€¢ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì¶”ê°€ ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤ (ìƒí’ˆë‹¹ ì•½ 2-5ì´ˆ)<br>
                â€¢ ë¯¸ë¦¬ë³´ê¸°ì—ì„œë„ ì²˜ìŒ 3ê°œ ìƒí’ˆì— ëŒ€í•´ GPT APIê°€ í˜¸ì¶œë©ë‹ˆë‹¤<br>
                â€¢ ì˜¤ë¥˜ ë°œìƒ ì‹œ "API Key í…ŒìŠ¤íŠ¸"ë¥¼ ëˆŒëŸ¬ í•´ê²° ë°©ë²•ì„ í™•ì¸í•˜ì„¸ìš”
            </div>
        </div>
        
        <!-- íŒŒì¼ ì—…ë¡œë“œ -->
        <div class="upload-area" id="uploadArea">
            <p style="font-size: 18px; color: #667eea; margin: 0 0 20px 0;">
                <strong>JSON íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</strong>
            </p>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                ğŸ“ íŒŒì¼ ì„ íƒ
            </button>
            <input type="file" id="fileInput" accept=".json" />
            <p style="margin: 20px 0 0 0; color: #666;">
                ì§€ì› í˜•ì‹: JSON (.json)
            </p>
        </div>
        
        <!-- ì§„í–‰ ìƒíƒœ -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <h3 id="loadingText" style="color: #667eea; margin: 15px 0;">ë³€í™˜ ì¤‘ì…ë‹ˆë‹¤...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <p id="progressText" style="font-size: 16px; font-weight: bold; color: #333; margin: 10px 0;">0 / 0 ì™„ë£Œ</p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding: 10px; background: #f0f1ff; border-radius: 8px;">
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ì²˜ë¦¬ ì†ë„</div>
                    <div id="processSpeed" style="font-size: 14px; font-weight: bold; color: #667eea;">ê³„ì‚° ì¤‘...</div>
                </div>
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ì˜ˆìƒ ë‚¨ì€ ì‹œê°„</div>
                    <div id="estimatedTime" style="font-size: 14px; font-weight: bold; color: #667eea;">ê³„ì‚° ì¤‘...</div>
                </div>
                <div style="text-align: center; flex: 1;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">í˜„ì¬ ë‹¨ê³„</div>
                    <div id="currentStep" style="font-size: 14px; font-weight: bold; color: #667eea;">ì¤€ë¹„ ì¤‘...</div>
                </div>
            </div>
        </div>
        
        <!-- ë³€í™˜ ë²„íŠ¼ -->
        <button class="convert-btn" id="convertBtn" disabled onclick="convertToExcel()">
            ğŸ”„ Excelë¡œ ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ
        </button>
        
        <!-- ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ -->
        <div class="download-section" id="downloadSection" style="display: none;">
            <div style="text-align: center; padding: 20px; background: #d4edda; border-radius: 10px; margin-top: 20px;">
                <h3 style="color: #155724; margin: 0 0 10px 0;">âœ… ë³€í™˜ ì™„ë£Œ!</h3>
                <p style="color: #155724; margin: 0 0 15px 0;">Excel íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="downloadAgain()">
                        ğŸ“¥ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button class="btn btn-success" onclick="forceDownload()">
                        ğŸ’¾ ê°•ì œ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ë¯¸ë¦¬ë³´ê¸° -->
        <div class="preview" id="preview">
            <h3>ğŸ“‹ ë³€í™˜ ë¯¸ë¦¬ë³´ê¸°</h3>
            <div id="previewContent"></div>
        </div>
    </div>

    <script>
        // í–¥ìƒëœ PriceParser í´ë˜ìŠ¤
        class PriceParser {
            constructor() {
                this.defaultMarginRate = 0.4;
            }

            extractPriceFromContent(content) {
                const priceMatch = content.match(/(\d+\.\d+)$/);
                if (priceMatch) {
                    return parseFloat(priceMatch[1]);
                }
                return null;
            }

            convertToWon(price) {
                return Math.round(price * 10000);
            }

            calculateSellingPrice(costPrice, marginRate = this.defaultMarginRate) {
                return Math.round(costPrice * (1 + marginRate));
            }

            getByteLength(str) {
                let byteLength = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charAt(i);
                    if (char.match(/[ã„±-ã…|ã…-ã…£|ê°€-í£]/)) {
                        byteLength += 3;
                    } else {
                        byteLength += 1;
                    }
                }
                return byteLength;
            }

            limitStringByBytes(str, maxBytes) {
                if (!str) return '';
                
                let result = '';
                let byteLength = 0;
                
                for (let i = 0; i < str.length; i++) {
                    const char = str.charAt(i);
                    const charBytes = char.match(/[ã„±-ã…|ã…-ã…£|ê°€-í£]/) ? 3 : 1;
                    
                    if (byteLength + charBytes > maxBytes) {
                        break;
                    }
                    
                    result += char;
                    byteLength += charBytes;
                }
                
                return result;
            }

            extractProductName(content) {
                if (!content) return '';
                
                const textOnly = content.replace(/<[^>]*>/g, '');
                const lines = textOnly.split('\n');
                let productName = lines[0] || '';
                
                const exclamationIndex = productName.indexOf('!!');
                if (exclamationIndex !== -1) {
                    productName = productName.substring(0, exclamationIndex);
                }
                
                productName = productName.replace(/\d+\.\d+$/, '').trim();
                return productName;
            }

            removeImagesFromText(content) {
                if (!content) return '';
                return content.replace(/<img[^>]*>/g, '').replace(/\d+\.\d+$/, '').trim();
            }

            extractImageUrls(content) {
                if (!content) return [];
                const imageUrls = [];
                const imgRegex = /src="([^"]+)"/g;
                let match;
                while ((match = imgRegex.exec(content)) !== null) {
                    imageUrls.push(match[1]);
                }
                return imageUrls;
            }

            removePrice(content) {
                if (!content) return '';
                return content.replace(/\d+\.\d+$/, '').trim();
            }

            async convertToExcelFormat(jsonData, marginRate = this.defaultMarginRate, useGpt = false, onProgress = null) {
                const headers = [
                    'ìƒí’ˆì½”ë“œ', 'ê¸°ë³¸ë¶„ë¥˜', 'ë¶„ë¥˜2', 'ë¶„ë¥˜3', 'ìƒí’ˆëª…', 'ì œì¡°ì‚¬', 'ì›ì‚°ì§€', 'ë¸Œëœë“œ', 'ëª¨ë¸',
                    'ìƒí’ˆìœ í˜•1', 'ìƒí’ˆìœ í˜•2', 'ìƒí’ˆìœ í˜•3', 'ìƒí’ˆìœ í˜•4', 'ìƒí’ˆìœ í˜•5', 'ê¸°ë³¸ì„¤ëª…', 'ìƒí’ˆì„¤ëª…', 
                    'ëª¨ë°”ì¼ìƒí’ˆì„¤ëª…', 'ì‹œì¤‘ê°€ê²©', 'íŒë§¤ê°€ê²©', 'ì „í™”ë¬¸ì˜', 'í¬ì¸íŠ¸', 'í¬ì¸íŠ¸íƒ€ì…', 'íŒë§¤ìì´ë©”ì¼',
                    'íŒë§¤ê°€ëŠ¥', 'ì¬ê³ ìˆ˜ëŸ‰', 'ì¬ê³ í†µë³´ìˆ˜ëŸ‰', 'ìµœì†Œêµ¬ë§¤ìˆ˜ëŸ‰', 'ìµœëŒ€êµ¬ë§¤ìˆ˜ëŸ‰', 'ê³¼ì„¸ìœ í˜•', 'ì •ë ¬ìˆœì„œ',
                    'ì´ë¯¸ì§€1', 'ì´ë¯¸ì§€2', 'ì´ë¯¸ì§€3', 'ì´ë¯¸ì§€4', 'ì´ë¯¸ì§€5', 'ì´ë¯¸ì§€6', 'ì´ë¯¸ì§€7', 'ì´ë¯¸ì§€8', 'ì´ë¯¸ì§€9', 'ì´ë¯¸ì§€10'
                ];

                const excelData = [headers];

                for (let index = 0; index < jsonData.length; index++) {
                    const item = jsonData[index];
                    
                    if (onProgress) {
                        onProgress(index + 1, jsonData.length);
                    }

                    // ê°€ê²© ì •ë³´ ì¶”ì¶œ
                    const rawPrice = this.extractPriceFromContent(item.content || '');
                    const costPrice = rawPrice ? this.convertToWon(rawPrice) : 0;
                    const sellingPrice = rawPrice ? this.calculateSellingPrice(costPrice, marginRate) : 0;

                    // ìƒí’ˆëª… ì¶”ì¶œ ë° 50ë°”ì´íŠ¸ ì œí•œ
                    const fullProductName = this.extractProductName(item.content || '');
                    let productName = this.limitStringByBytes(fullProductName, 50);
                    
                    // GPTë¡œ ìƒí’ˆëª… ê°œì„ 
                    if (useGpt && fullProductName) {
                        try {
                            const enhancedName = await this.enhanceProductNameWithGPT(fullProductName);
                            if (enhancedName) {
                                productName = this.limitStringByBytes(enhancedName, 50);
                            }
                        } catch (error) {
                            console.warn(`ìƒí’ˆ ${index + 1} ìƒí’ˆëª… GPT ì²˜ë¦¬ ì‹¤íŒ¨:`, error.message);
                        }
                    }

                    // ê¸°ë³¸ì„¤ëª…: ì´ë¯¸ì§€ ë§í¬ ì‚­ì œ, ê°€ê²© ì œê±°
                    const basicDescription = this.removeImagesFromText(item.content || '');

                    // ì´ë¯¸ì§€ URL ì¶”ì¶œ
                    const imageUrls = this.extractImageUrls(item.content || '').slice(0, 10);

                    // ìƒí’ˆì„¤ëª…ê³¼ ëª¨ë°”ì¼ìƒí’ˆì„¤ëª…: ì´ë¯¸ì§€ í¬í•¨, ê°€ê²© ì œê±°
                    let productDescription = this.removePrice(item.content || '');
                    let mobileDescription = this.removePrice(item.content || '');

                    // GPTë¡œ ìƒí’ˆì„¤ëª… ê°œì„ 
                    if (useGpt && productDescription) {
                        try {
                            const enhancedDescription = await this.enhanceDescriptionWithGPT(productDescription);
                            if (enhancedDescription) {
                                productDescription = enhancedDescription;
                                mobileDescription = enhancedDescription;
                            }
                        } catch (error) {
                            console.warn(`ìƒí’ˆ ${index + 1} GPT ì²˜ë¦¬ ì‹¤íŒ¨:`, error.message);
                            // GPT ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ ìœ ì§€í•˜ê³  ê³„ì† ì§„í–‰
                        }
                    }

                    const rowData = [
                        `PRODUCT_${String(index + 1).padStart(4, '0')}`,
                        '10',
                        '', '', 
                        productName,
                        '', 'êµ­ë‚´', '', '',
                        '0', '0', '0', '0', '0',
                        basicDescription,        // ê¸°ë³¸ì„¤ëª…: ì´ë¯¸ì§€ ë§í¬ ì‚­ì œ, ê°€ê²© ì œê±°
                        productDescription,      // ìƒí’ˆì„¤ëª…: ì´ë¯¸ì§€ í¬í•¨, ê°€ê²© ì œê±°, GPT ê°œì„ 
                        mobileDescription,       // ëª¨ë°”ì¼ìƒí’ˆì„¤ëª…: ì´ë¯¸ì§€ í¬í•¨, ê°€ê²© ì œê±°, GPT ê°œì„ 
                        costPrice,              // ì‹œì¤‘ê°€ê²©: ì›ê°€
                        sellingPrice,           // íŒë§¤ê°€ê²©: 40% ë§ˆì§„
                        '0', '', '1', '',
                        '1', '999', '0', '1', '10', '0',
                        index + 1,
                        ...imageUrls,
                        ...Array(10 - imageUrls.length).fill('')
                    ];

                    excelData.push(rowData);
                }

                return excelData;
            }

            async enhanceDescriptionWithGPT(description) {
                const apiKey = localStorage.getItem('gptApiKey');
                const prompt = localStorage.getItem('gptPrompt') || this.getDefaultPrompt();
                
                if (!apiKey) {
                    throw new Error('API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                // CORS í”„ë¡ì‹œ ì‚¬ìš© (ì—¬ëŸ¬ ê°œì˜ í”„ë¡ì‹œ URL ì‹œë„)
                const proxyUrls = [
                    'https://cors-anywhere.herokuapp.com/',
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?'
                ];

                const apiUrl = 'https://api.openai.com/v1/chat/completions';
                
                for (const proxyUrl of proxyUrls) {
                    try {
                        const response = await fetch(proxyUrl + apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                model: 'gpt-3.5-turbo',
                                messages: [
                                    {
                                        role: 'system',
                                        content: prompt
                                    },
                                    {
                                        role: 'user',
                                        content: description
                                    }
                                ],
                                max_tokens: 1000,
                                temperature: 0.7
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            return data.choices[0].message.content;
                        }
                    } catch (error) {
                        console.warn(`í”„ë¡ì‹œ ${proxyUrl} ì‹¤íŒ¨:`, error);
                        continue;
                    }
                }

                // ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í˜¸ì¶œ ì‹œë„
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'system',
                                    content: prompt
                                },
                                {
                                    role: 'user',
                                    content: description
                                }
                            ],
                            max_tokens: 1000,
                            temperature: 0.7
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.choices[0].message.content;
                    } else {
                        throw new Error(`GPT API ì˜¤ë¥˜: ${response.status}`);
                    }
                } catch (error) {
                    throw new Error(`GPT API ì—°ê²° ì‹¤íŒ¨: ${error.message}. CORS í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ë¸Œë¼ìš°ì € í™•ì¥ í”„ë¡œê·¸ë¨ì„ ì„¤ì¹˜í•´ì£¼ì„¸ìš”.`);
                }
            }

            async enhanceProductNameWithGPT(productName) {
                const apiKey = localStorage.getItem('gptApiKey');
                
                if (!apiKey) {
                    throw new Error('API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                const namePrompt = `ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ ìƒí’ˆëª… ì‘ì„±ìì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ìƒí’ˆëª…ì„ ë‹¤ìŒê³¼ ê°™ì´ ê°œì„ í•´ì£¼ì„¸ìš”:

1. ê³ ê°ì˜ ëˆˆê¸¸ì„ ë„ëŠ” ë§¤ë ¥ì ì¸ ìƒí’ˆëª…ìœ¼ë¡œ ë³€ê²½
2. í•µì‹¬ í‚¤ì›Œë“œëŠ” ìœ ì§€í•˜ë©´ì„œ ë” íŒë§¤ë ¥ ìˆê²Œ í‘œí˜„
3. 50ë°”ì´íŠ¸ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±
4. ë¸Œëœë“œëª…ì´ë‚˜ ëª¨ë¸ëª…ì€ ì •í™•íˆ ìœ ì§€
5. íŠ¹ìˆ˜ë¬¸ìë‚˜ ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•˜ì§€ ë§ê³  ê¹”ë”í•˜ê²Œ ì‘ì„±

ì›ë³¸ ìƒí’ˆëª…: ${productName}

ê°œì„ ëœ ìƒí’ˆëª…ë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”:`;

                // CORS í”„ë¡ì‹œ ì‚¬ìš©
                const proxyUrls = [
                    'https://cors-anywhere.herokuapp.com/',
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?'
                ];

                const apiUrl = 'https://api.openai.com/v1/chat/completions';
                
                for (const proxyUrl of proxyUrls) {
                    try {
                        const response = await fetch(proxyUrl + apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`,
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                model: 'gpt-3.5-turbo',
                                messages: [
                                    {
                                        role: 'user',
                                        content: namePrompt
                                    }
                                ],
                                max_tokens: 100,
                                temperature: 0.7
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            return data.choices[0].message.content.trim();
                        }
                    } catch (error) {
                        console.warn(`í”„ë¡ì‹œ ${proxyUrl} ì‹¤íŒ¨:`, error);
                        continue;
                    }
                }

                // ëª¨ë“  í”„ë¡ì‹œ ì‹¤íŒ¨ ì‹œ ì§ì ‘ í˜¸ì¶œ ì‹œë„
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'gpt-3.5-turbo',
                            messages: [
                                {
                                    role: 'user',
                                    content: namePrompt
                                }
                            ],
                            max_tokens: 100,
                            temperature: 0.7
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        return data.choices[0].message.content.trim();
                    } else {
                        throw new Error(`GPT API ì˜¤ë¥˜: ${response.status}`);
                    }
                } catch (error) {
                    throw new Error(`GPT API ì—°ê²° ì‹¤íŒ¨: ${error.message}`);
                }
            }
        }

        // ì „ì—­ ë³€ìˆ˜
        let jsonData = null;
        let lastExcelData = null;
        let lastFilename = null;
        let processingStartTime = null;
        let lastProgressUpdate = null;
        const priceParser = new PriceParser();

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedSettings();
            setupEventListeners();
        });

        function loadSavedSettings() {
            const savedApiKey = localStorage.getItem('gptApiKey');
            const savedPrompt = localStorage.getItem('gptPrompt');
            
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
                document.getElementById('apiKeySaved').style.display = 'block';
            }
            
            if (savedPrompt) {
                document.getElementById('gptPrompt').value = savedPrompt;
                document.getElementById('promptSaved').style.display = 'block';
            } else {
                document.getElementById('gptPrompt').value = priceParser.getDefaultPrompt();
            }
        }

        function setupEventListeners() {
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            // ì´ìµë¥  ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            document.getElementById('marginRate').addEventListener('input', async function() {
                if (jsonData) {
                    await showPreview(jsonData.slice(0, 3));
                }
            });
            
            // GPT ì‚¬ìš© ì—¬ë¶€ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
            document.getElementById('useGpt').addEventListener('change', async function() {
                if (jsonData) {
                    await showPreview(jsonData.slice(0, 3));
                }
            });
            
            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            document.getElementById('skipImageUpload').addEventListener('change', function() {
                checkImageCacheStatus();
            });
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ë¯¸ì§€ ìºì‹œ ìƒíƒœ í™•ì¸
            checkImageCacheStatus();
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey) {
                localStorage.setItem('gptApiKey', apiKey);
                document.getElementById('apiKeySaved').style.display = 'block';
                showAlert('âœ… API Keyê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showAlert('âŒ API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        function savePrompt() {
            const prompt = document.getElementById('gptPrompt').value.trim();
            if (prompt) {
                localStorage.setItem('gptPrompt', prompt);
                document.getElementById('promptSaved').style.display = 'block';
                showAlert('âœ… í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showAlert('âŒ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        function loadDefaultPrompt() {
            document.getElementById('gptPrompt').value = priceParser.getDefaultPrompt();
            showAlert('âœ… ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }

        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showAlert('âŒ API Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                showAlert('ğŸ”„ API Key í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
                
                // ì—¬ëŸ¬ í”„ë¡ì‹œ ì‹œë„
                const proxyUrls = [
                    'https://cors-anywhere.herokuapp.com/',
                    'https://api.allorigins.win/raw?url=',
                    'https://corsproxy.io/?'
                ];

                const apiUrl = 'https://api.openai.com/v1/models';
                
                for (const proxyUrl of proxyUrls) {
                    try {
                        const response = await fetch(proxyUrl + apiUrl, {
                            headers: {
                                'Authorization': `Bearer ${apiKey}`,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        if (response.ok) {
                            showAlert('âœ… API Keyê°€ ìœ íš¨í•©ë‹ˆë‹¤!', 'success');
                            return;
                        }
                    } catch (error) {
                        console.warn(`í”„ë¡ì‹œ ${proxyUrl} ì‹¤íŒ¨:`, error);
                        continue;
                    }
                }

                // ì§ì ‘ í˜¸ì¶œ ì‹œë„
                try {
                    const response = await fetch(apiUrl, {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });

                    if (response.ok) {
                        showAlert('âœ… API Keyê°€ ìœ íš¨í•©ë‹ˆë‹¤!', 'success');
                    } else {
                        showAlert('âŒ API Keyê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                    }
                } catch (error) {
                    showAlert('âŒ CORS ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì•„ë˜ í•´ê²° ë°©ë²•ì„ ì°¸ê³ í•˜ì„¸ìš”.', 'error');
                    showCorsHelp();
                }
            } catch (error) {
                showAlert('âŒ API Key í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                showCorsHelp();
            }
        }

        function showCorsHelp() {
            const helpMessage = `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <h4 style="color: #856404; margin-top: 0;">ğŸ”§ CORS ë¬¸ì œ í•´ê²° ë°©ë²•</h4>
                    <p style="margin: 10px 0; color: #856404;">
                        <strong>1. CORS í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜ (ì¶”ì²œ)</strong><br>
                        - Chrome: "CORS Unblock" ë˜ëŠ” "CORS Everywhere" í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜<br>
                        - Firefox: "CORS Everywhere" í™•ì¥ í”„ë¡œê·¸ë¨ ì„¤ì¹˜<br><br>
                        <strong>2. ë¸Œë¼ìš°ì € í”Œë˜ê·¸ ì‚¬ìš©</strong><br>
                        - Chrome: --disable-web-security --user-data-dir="C:/temp" í”Œë˜ê·¸ë¡œ ì‹¤í–‰<br><br>
                        <strong>3. ë‹¤ë¥¸ ë¸Œë¼ìš°ì € ì‹œë„</strong><br>
                        - Edge, Safari ë“± ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ì—ì„œ í…ŒìŠ¤íŠ¸<br><br>
                        <strong>4. GPT ì—†ì´ ì‚¬ìš©</strong><br>
                        - "GPT ì‚¬ìš©" ì²´í¬ë°•ìŠ¤ë¥¼ í•´ì œí•˜ê³  ê¸°ë³¸ ê¸°ëŠ¥ë§Œ ì´ìš©
                    </p>
                </div>
            `;
            
            const alertDiv = document.getElementById('alert');
            alertDiv.innerHTML = helpMessage;
            alertDiv.className = 'alert info';
            alertDiv.style.display = 'block';
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadArea').classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleFile(file) {
            if (!file.name.endsWith('.json')) {
                showAlert('JSON íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    jsonData = JSON.parse(e.target.result);
                    showAlert(`âœ… ${file.name} íŒŒì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. (${jsonData.length}ê°œ ìƒí’ˆ)`, 'success');
                    document.getElementById('convertBtn').disabled = false;
                    await showPreview(jsonData.slice(0, 3));
                } catch (error) {
                    showAlert('âŒ JSON íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                    console.error('JSON íŒŒì‹± ì˜¤ë¥˜:', error);
                }
            };
            reader.readAsText(file);
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            // ì¤„ë°”ê¿ˆ ë¬¸ìë¥¼ <br> íƒœê·¸ë¡œ ë³€í™˜
            const formattedMessage = message.replace(/\n/g, '<br>');
            alert.innerHTML = formattedMessage;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 8000); // ì„±ê³µ ë©”ì‹œì§€ëŠ” 8ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            }
        }

        async function showPreview(data) {
            const preview = document.getElementById('preview');
            const content = document.getElementById('previewContent');
            const marginRate = parseFloat(document.getElementById('marginRate').value) / 100;
            const useGpt = document.getElementById('useGpt').checked;
            
            content.innerHTML = '';
            
            // ë¯¸ë¦¬ë³´ê¸° ë¡œë”© í‘œì‹œ
            if (useGpt) {
                const loadingDiv = document.createElement('div');
                loadingDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px; background: #f8f9ff; border-radius: 10px; border: 2px dashed #667eea;">
                        <div style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px;"></div>
                        <h4 style="color: #667eea; margin: 0 0 10px 0;">ğŸ¤– GPTë¡œ ìƒí’ˆëª… ê°œì„  ì¤‘...</h4>
                        <p style="color: #666; margin: 0; font-size: 14px;">ì²˜ìŒ 3ê°œ ìƒí’ˆì˜ ìƒí’ˆëª…ì„ ë¶„ì„í•˜ê³  ê°œì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                        <p style="color: #999; margin: 5px 0 0 0; font-size: 12px;">ì´ ê³¼ì •ì€ ì•½ 10-30ì´ˆ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                content.appendChild(loadingDiv);
                preview.style.display = 'block';
            }
            
            for (let index = 0; index < data.length; index++) {
                const item = data[index];
                
                const rawPrice = priceParser.extractPriceFromContent(item.content || '');
                const costPrice = rawPrice ? priceParser.convertToWon(rawPrice) : 0;
                const sellingPrice = rawPrice ? priceParser.calculateSellingPrice(costPrice, marginRate) : 0;
                
                // ì›ë³¸ ìƒí’ˆëª…
                const originalProductName = priceParser.extractProductName(item.content || '');
                const limitedOriginalName = priceParser.limitStringByBytes(originalProductName, 50);
                
                // GPT ê°œì„ ëœ ìƒí’ˆëª…
                let enhancedProductName = limitedOriginalName;
                if (useGpt && originalProductName) {
                    try {
                        const enhanced = await priceParser.enhanceProductNameWithGPT(originalProductName);
                        if (enhanced) {
                            // 50ë°”ì´íŠ¸ ì œí•œ
                            enhancedProductName = priceParser.limitStringByBytes(enhanced, 50);
                        }
                    } catch (error) {
                        console.warn(`ë¯¸ë¦¬ë³´ê¸° GPT ì²˜ë¦¬ ì‹¤íŒ¨ (ìƒí’ˆ ${index + 1}):`, error.message);
                    }
                }
                
                // ë¯¸ë¦¬ë³´ê¸° ì•„ì´í…œ ìƒì„±
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                
                const productNameHtml = useGpt ? `
                    <div style="margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #6c757d;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="color: #6c757d; font-weight: bold; font-size: 12px;">ğŸ“ ì›ë³¸ ìƒí’ˆëª…</span>
                                    <span style="margin-left: 8px; background: #6c757d; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">${priceParser.getByteLength(limitedOriginalName)}ë°”ì´íŠ¸</span>
                                </div>
                                <div style="font-size: 14px; line-height: 1.4;">${limitedOriginalName || 'ìƒí’ˆëª… ì—†ìŒ'}</div>
                            </div>
                            <div style="background: #e8f5e8; padding: 12px; border-radius: 8px; border-left: 4px solid #28a745;">
                                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                    <span style="color: #28a745; font-weight: bold; font-size: 12px;">ğŸ¤– GPT ê°œì„  ìƒí’ˆëª…</span>
                                    <span style="margin-left: 8px; background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">${enhancedProductName ? priceParser.getByteLength(enhancedProductName) : '0'}ë°”ì´íŠ¸</span>
                                </div>
                                <div style="font-size: 14px; font-weight: bold; line-height: 1.4;">${enhancedProductName || 'ì²˜ë¦¬ ì¤‘...'}</div>
                            </div>
                        </div>
                    </div>
                ` : `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <span style="color: #333; font-weight: bold; font-size: 14px;">ğŸ“ ìƒí’ˆëª…</span>
                            <span style="margin-left: 8px; background: #667eea; color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">${priceParser.getByteLength(limitedOriginalName)}ë°”ì´íŠ¸</span>
                        </div>
                        <div style="font-size: 16px; font-weight: bold; color: #333;">${limitedOriginalName || 'ìƒí’ˆëª… ì—†ìŒ'}</div>
                    </div>
                `;
                
                previewItem.innerHTML = `
                    ${productNameHtml}
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 10px;">
                        <div style="background: #f0f1ff; padding: 10px; border-radius: 5px; text-align: center;">
                            <small>ì›ì‹œ ê°€ê²©</small>
                            <strong style="display: block; color: #667eea; font-size: 18px;">${rawPrice || 'N/A'}</strong>
                        </div>
                        <div style="background: #f0f1ff; padding: 10px; border-radius: 5px; text-align: center;">
                            <small>ì‹œì¤‘ê°€ê²© (ì›ê°€)</small>
                            <strong style="display: block; color: #667eea; font-size: 18px;">${costPrice.toLocaleString()}ì›</strong>
                        </div>
                        <div style="background: #f0f1ff; padding: 10px; border-radius: 5px; text-align: center;">
                            <small>íŒë§¤ê°€ê²© (+${(marginRate*100).toFixed(1)}%)</small>
                            <strong style="display: block; color: #667eea; font-size: 18px;">${sellingPrice.toLocaleString()}ì›</strong>
                        </div>
                    </div>
                `;
                
                // ë¡œë”© í‘œì‹œ ì œê±° í›„ ì•„ì´í…œ ì¶”ê°€
                if (useGpt && index === 0) {
                    content.innerHTML = '';
                }
                
                content.appendChild(previewItem);
            }
            
            if (jsonData.length > 3) {
                const moreInfo = document.createElement('div');
                moreInfo.innerHTML = `
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9ff; border-radius: 8px; border: 1px dashed #667eea;">
                        <strong style="color: #667eea;">... ì™¸ ${jsonData.length - 3}ê°œ ìƒí’ˆ ë”</strong>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">
                            ${useGpt ? 'GPT ë³€í™˜ì€ ì‹¤ì œ ë³€í™˜ ì‹œì—ë§Œ ëª¨ë“  ìƒí’ˆì— ì ìš©ë©ë‹ˆë‹¤.' : ''}
                        </p>
                    </div>
                `;
                content.appendChild(moreInfo);
            }
            
            preview.style.display = 'block';
        }

        function updateProgress(current, total, statusText = '', currentStep = '') {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const loadingText = document.getElementById('loadingText');
            const processSpeed = document.getElementById('processSpeed');
            const estimatedTime = document.getElementById('estimatedTime');
            const currentStepEl = document.getElementById('currentStep');
            
            const percentage = (current / total) * 100;
            
            // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
            progressFill.style.width = `${percentage}%`;
            progressText.textContent = `${current} / ${total} ì™„ë£Œ (${percentage.toFixed(1)}%)`;
            
            if (statusText) {
                loadingText.textContent = statusText;
            }
            
            // í˜„ì¬ ë‹¨ê³„ í‘œì‹œ
            if (currentStep) {
                currentStepEl.textContent = currentStep;
            } else if (current === 0) {
                currentStepEl.textContent = 'ì¤€ë¹„ ì¤‘...';
            } else if (current === total) {
                currentStepEl.textContent = 'ì™„ë£Œ!';
            } else {
                currentStepEl.textContent = `${current}ë²ˆì§¸ ìƒí’ˆ ì²˜ë¦¬ ì¤‘`;
            }
            
            // ì²˜ë¦¬ ì†ë„ ë° ì˜ˆìƒ ì‹œê°„ ê³„ì‚°
            const now = Date.now();
            if (processingStartTime && current > 0) {
                const elapsedTime = (now - processingStartTime) / 1000; // ì´ˆ
                const itemsPerSecond = current / elapsedTime;
                const remainingItems = total - current;
                const estimatedRemainingTime = remainingItems / itemsPerSecond;
                
                // ì²˜ë¦¬ ì†ë„ í‘œì‹œ
                if (itemsPerSecond >= 1) {
                    processSpeed.textContent = `${itemsPerSecond.toFixed(1)} ìƒí’ˆ/ì´ˆ`;
                } else {
                    processSpeed.textContent = `${(60 / itemsPerSecond).toFixed(1)} ì´ˆ/ìƒí’ˆ`;
                }
                
                // ì˜ˆìƒ ë‚¨ì€ ì‹œê°„ í‘œì‹œ
                if (current === total) {
                    estimatedTime.textContent = 'ì™„ë£Œ!';
                } else if (estimatedRemainingTime < 60) {
                    estimatedTime.textContent = `${Math.ceil(estimatedRemainingTime)}ì´ˆ`;
                } else if (estimatedRemainingTime < 3600) {
                    const minutes = Math.ceil(estimatedRemainingTime / 60);
                    estimatedTime.textContent = `${minutes}ë¶„`;
                } else {
                    const hours = Math.floor(estimatedRemainingTime / 3600);
                    const minutes = Math.ceil((estimatedRemainingTime % 3600) / 60);
                    estimatedTime.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„`;
                }
            } else {
                processSpeed.textContent = 'ê³„ì‚° ì¤‘...';
                estimatedTime.textContent = 'ê³„ì‚° ì¤‘...';
            }
            
            // ì§„í–‰ë¥ ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
            if (percentage < 30) {
                progressFill.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
            } else if (percentage < 70) {
                progressFill.style.background = 'linear-gradient(135deg, #feca57, #ff9ff3)';
            } else {
                progressFill.style.background = 'linear-gradient(135deg, #48dbfb, #0abde3)';
            }
            
            // ì™„ë£Œ ì‹œ ë…¹ìƒ‰ìœ¼ë¡œ ë³€ê²½
            if (percentage >= 100) {
                progressFill.style.background = 'linear-gradient(135deg, #1dd1a1, #10ac84)';
                progressText.textContent = `${total} / ${total} ì™„ë£Œ (100%) - ì²˜ë¦¬ ì™„ë£Œ!`;
                processSpeed.textContent = 'ì™„ë£Œ!';
                estimatedTime.textContent = 'ì™„ë£Œ!';
                currentStepEl.textContent = 'ëª¨ë“  ìƒí’ˆ ì²˜ë¦¬ ì™„ë£Œ!';
            }
        }

        async function convertToExcel() {
            if (!jsonData) {
                showAlert('ë¨¼ì € JSON íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.', 'error');
                return;
            }

            const useGpt = document.getElementById('useGpt').checked;
            const skipImageUpload = document.getElementById('skipImageUpload').checked;
            
            if (useGpt && !localStorage.getItem('gptApiKey')) {
                showAlert('GPT ì‚¬ìš©ì„ ìœ„í•´ API Keyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸ ëª¨ë“œ ì²´í¬
            if (skipImageUpload) {
                const savedImages = localStorage.getItem('imgbbImageMap');
                if (!savedImages) {
                    const confirm = window.confirm('ì €ì¥ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸ ëª¨ë“œì—ì„œëŠ” ì´ì „ì— ì—…ë¡œë“œí•œ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.\nì›ë³¸ ì´ë¯¸ì§€ URLì„ ì‚¬ìš©í•˜ì—¬ ê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                    if (!confirm) {
                        return;
                    }
                }
            }

            const loading = document.getElementById('loading');
            const convertBtn = document.getElementById('convertBtn');
            const downloadSection = document.getElementById('downloadSection');
            
            // ë¡œë”© ì‹œì‘ - ì‹œê°„ ì¶”ì  ì‹œì‘
            processingStartTime = Date.now();
            loading.style.display = 'block';
            convertBtn.disabled = true;
            convertBtn.innerHTML = 'â³ Excelë¡œ ë³€í™˜ ì¤‘...';
            convertBtn.style.opacity = '0.6';
            convertBtn.style.cursor = 'not-allowed';
            downloadSection.style.display = 'none';
            
            // ì§„í–‰ë¥  ì´ˆê¸°í™”
            updateProgress(0, jsonData.length, 'ğŸ”„ ë³€í™˜ ì¤€ë¹„ ì¤‘...', 'ì‹œìŠ¤í…œ ì´ˆê¸°í™”');

            try {
                const marginRate = parseFloat(document.getElementById('marginRate').value) / 100;
                let filename = document.getElementById('filename').value || 'products.xlsx';
                
                if (!filename.toLowerCase().endsWith('.xlsx')) {
                    filename += '.xlsx';
                }

                // ë¡œë”© ë©”ì‹œì§€ ì„¤ì •
                let baseLoadingMessage = '';
                if (useGpt && !skipImageUpload) {
                    baseLoadingMessage = 'ğŸ¤– GPT ê°œì„  ë° ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...';
                } else if (useGpt && skipImageUpload) {
                    baseLoadingMessage = 'ğŸ¤– GPT ê°œì„  ë° ğŸ”— ì´ë¯¸ì§€ ë§¤ì¹­ ì¤‘...';
                } else if (!useGpt && !skipImageUpload) {
                    baseLoadingMessage = 'ğŸ“· ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ğŸ“Š Excel ë³€í™˜ ì¤‘...';
                } else {
                    baseLoadingMessage = 'ğŸ”— ì´ë¯¸ì§€ ë§¤ì¹­ ë° ğŸ“Š Excel ë³€í™˜ ì¤‘...';
                }

                updateProgress(0, jsonData.length, baseLoadingMessage, 'ë°ì´í„° ë¶„ì„ ì¤‘');
                
                // ì•½ê°„ì˜ ë”œë ˆì´ë¡œ UI ì—…ë°ì´íŠ¸ ë³´ì¥
                await new Promise(resolve => setTimeout(resolve, 800));

                // ë³€í™˜ ì‹¤í–‰
                const excelData = await priceParser.convertToExcelFormat(
                    jsonData, 
                    marginRate, 
                    useGpt,
                    skipImageUpload,
                    (current, total, status) => {
                        const detailStatus = status || baseLoadingMessage;
                        let currentStep = '';
                        
                        if (useGpt && !skipImageUpload) {
                            currentStep = 'GPT ê°œì„  + ì´ë¯¸ì§€ ì—…ë¡œë“œ';
                        } else if (useGpt && skipImageUpload) {
                            currentStep = 'GPT ê°œì„  + ì´ë¯¸ì§€ ë§¤ì¹­';
                        } else if (!useGpt && !skipImageUpload) {
                            currentStep = 'ì´ë¯¸ì§€ ì—…ë¡œë“œ';
                        } else {
                            currentStep = 'ì´ë¯¸ì§€ ë§¤ì¹­';
                        }
                        
                        updateProgress(current, total, `${detailStatus} (${current}/${total})`, currentStep);
                    }
                );
                
                // ë³€í™˜ ê²°ê³¼ ê²€ì¦
                if (!excelData || excelData.length < 2) {
                    throw new Error('ë³€í™˜ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì…ë ¥ íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
                
                // Excel íŒŒì¼ ìƒì„± ë‹¨ê³„
                updateProgress(jsonData.length, jsonData.length, 'ğŸ“Š Excel íŒŒì¼ ìƒì„± ì¤‘...', 'Excel íŒŒì¼ ìƒì„±');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const worksheet = XLSX.utils.aoa_to_sheet(excelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "ìƒí’ˆëª©ë¡");
                
                // ë‹¤ìš´ë¡œë“œ ì¤€ë¹„
                updateProgress(jsonData.length, jsonData.length, 'ğŸ’¾ ë‹¤ìš´ë¡œë“œ ì¤€ë¹„ ì¤‘...', 'ë‹¤ìš´ë¡œë“œ ì¤€ë¹„');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const downloadSuccess = downloadExcelFile(workbook, filename);
                
                if (downloadSuccess) {
                    lastExcelData = excelData;
                    lastFilename = filename;
                    
                    // ìµœì¢… ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
                    updateProgress(jsonData.length, jsonData.length, 'âœ… ë³€í™˜ ì™„ë£Œ!', 'ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
                    
                    // ì„±ê³µ ë©”ì‹œì§€ ìƒì„±
                    let successMessage = `âœ… ${filename} íŒŒì¼ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (${jsonData.length}ê°œ ìƒí’ˆ)`;
                    
                    if (useGpt) {
                        successMessage += `\nğŸ¤– GPTë¡œ ìƒí’ˆëª…ê³¼ ì„¤ëª…ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    }
                    
                    if (!skipImageUpload) {
                        successMessage += `\nğŸ“· ì´ë¯¸ì§€ê°€ ì´ë¯¸ì§€BBì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    } else {
                        const savedImages = localStorage.getItem('imgbbImageMap');
                        const imageCount = savedImages ? Object.keys(JSON.parse(savedImages)).length : 0;
                        successMessage += `\nğŸ”— ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤. (${imageCount}ê°œ ì´ë¯¸ì§€ ìºì‹œ ì‚¬ìš©)`;
                    }
                    
                    // ì²˜ë¦¬ ì‹œê°„ ê³„ì‚°
                    const totalTime = ((Date.now() - processingStartTime) / 1000).toFixed(1);
                    successMessage += `\nâ±ï¸ ì²˜ë¦¬ ì‹œê°„: ${totalTime}ì´ˆ`;
                    
                    showAlert(successMessage, 'success');
                    downloadSection.style.display = 'block';
                    
                    // ë²„íŠ¼ ìƒíƒœ ì„±ê³µìœ¼ë¡œ ë³€ê²½
                    convertBtn.innerHTML = 'âœ… ë³€í™˜ ì™„ë£Œ - ë‹¤ì‹œ ë³€í™˜í•˜ê¸°';
                    convertBtn.style.background = 'linear-gradient(135deg, #1dd1a1, #10ac84)';
                    
                } else {
                    throw new Error('ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
                
            } catch (error) {
                console.error('ë³€í™˜ ì‹¤í–‰ ì˜¤ë¥˜:', error);
                
                let errorMessage = 'âŒ ë³€í™˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
                
                // êµ¬ì²´ì ì¸ ì˜¤ë¥˜ íƒ€ì…ë³„ ì•ˆë‚´
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    errorMessage += '\n\nğŸ”§ CORS ë¬¸ì œë¡œ ë³´ì…ë‹ˆë‹¤. API Key í…ŒìŠ¤íŠ¸ë¥¼ ëˆŒëŸ¬ í•´ê²° ë°©ë²•ì„ í™•ì¸í•˜ì„¸ìš”.';
                } else if (error.message.includes('ì´ë¯¸ì§€')) {
                    errorMessage += '\n\nğŸ“· ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸" ì˜µì…˜ì„ ì‚¬ìš©í•´ë³´ì„¸ìš”.';
                } else if (error.message.includes('GPT')) {
                    errorMessage += '\n\nğŸ¤– GPT ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. "GPT ì‚¬ìš©" ì˜µì…˜ì„ í•´ì œí•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.';
                } else if (error.message.includes('ë³€í™˜ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤')) {
                    errorMessage += '\n\nğŸ“„ JSON íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ì˜¬ë°”ë¥¸ ìƒí’ˆ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.';
                }
                
                showAlert(errorMessage, 'error');
                
                // ë²„íŠ¼ ìƒíƒœ ì˜¤ë¥˜ë¡œ ë³€ê²½
                convertBtn.innerHTML = 'âŒ ë³€í™˜ ì‹¤íŒ¨ - ë‹¤ì‹œ ì‹œë„';
                convertBtn.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a52)';
                
                // ì§„í–‰ë¥  ì˜¤ë¥˜ í‘œì‹œ
                updateProgress(0, jsonData.length, 'âŒ ë³€í™˜ ì‹¤íŒ¨', 'ì˜¤ë¥˜ ë°œìƒ');
                
            } finally {
                // ë¡œë”© ìƒíƒœ í•´ì œ (3ì´ˆ í›„)
                setTimeout(() => {
                    loading.style.display = 'none';
                    convertBtn.disabled = false;
                    convertBtn.style.opacity = '1';
                    convertBtn.style.cursor = 'pointer';
                    
                    // ë²„íŠ¼ ì›ë˜ ìƒíƒœë¡œ ë³µê·€
                    convertBtn.innerHTML = 'ğŸ”„ Excelë¡œ ë³€í™˜ ë° ë‹¤ìš´ë¡œë“œ';
                    convertBtn.style.background = 'linear-gradient(135deg, #764ba2, #667eea)';
                    
                    // ì§„í–‰ë¥  ë¦¬ì…‹
                    document.getElementById('progressFill').style.width = '0%';
                    document.getElementById('progressText').textContent = '0 / 0 ì™„ë£Œ';
                    document.getElementById('progressFill').style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                    
                    // ì²˜ë¦¬ ì‹œê°„ ë³€ìˆ˜ ë¦¬ì…‹
                    processingStartTime = null;
                }, 3000);
            }
        }

        function downloadExcelFile(workbook, filename) {
            try {
                XLSX.writeFile(workbook, filename);
                return true;
            } catch (error) {
                console.log('XLSX.writeFile ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‚¬ìš©:', error);
                
                try {
                    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    return true;
                } catch (blobError) {
                    console.error('Blob ë‹¤ìš´ë¡œë“œë„ ì‹¤íŒ¨:', blobError);
                    return false;
                }
            }
        }

        function downloadAgain() {
            if (!lastExcelData || !lastFilename) {
                showAlert('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë³€í™˜ì„ ì§„í–‰í•˜ì„¸ìš”.', 'error');
                return;
            }

            try {
                const worksheet = XLSX.utils.aoa_to_sheet(lastExcelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "ìƒí’ˆëª©ë¡");
                
                const downloadSuccess = downloadExcelFile(workbook, lastFilename);
                
                if (downloadSuccess) {
                    showAlert(`âœ… ${lastFilename} íŒŒì¼ì„ ë‹¤ì‹œ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤!`, 'success');
                } else {
                    showAlert('âŒ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showAlert('âŒ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                console.error('ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function clearImageCache() {
            const savedImages = localStorage.getItem('imgbbImageMap');
            const imageCount = savedImages ? Object.keys(JSON.parse(savedImages)).length : 0;
            
            if (imageCount === 0) {
                showAlert('ì‚­ì œí•  ì´ë¯¸ì§€ ìºì‹œê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                return;
            }
            
            const confirm = window.confirm(`ì €ì¥ëœ ì´ë¯¸ì§€ ìºì‹œë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ${imageCount}ê°œì˜ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\nì‚­ì œ í›„ì—ëŠ” "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸" ì˜µì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            
            if (confirm) {
                localStorage.removeItem('imgbbImageMap');
                priceParser.uploadedImageMap.clear();
                showAlert(`âœ… ${imageCount}ê°œì˜ ì´ë¯¸ì§€ ìºì‹œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            }
        }

        function showImageCache() {
            const savedImages = localStorage.getItem('imgbbImageMap');
            
            if (!savedImages) {
                showAlert('ğŸ’¡ ì €ì¥ëœ ì´ë¯¸ì§€ ìºì‹œê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ í•œ ë²ˆ ì‹¤í–‰í•˜ë©´ ì´ë¯¸ì§€ë“¤ì´ ì´ë¯¸ì§€BBì— ì €ì¥ë˜ì–´ ìºì‹œì— ë“±ë¡ë©ë‹ˆë‹¤.', 'info');
                return;
            }

            const imageMap = JSON.parse(savedImages);
            const imageCount = Object.keys(imageMap).length;
            
            if (imageCount === 0) {
                showAlert('ì €ì¥ëœ ì´ë¯¸ì§€ ìºì‹œê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                return;
            }

            // ìºì‹œ ì •ë³´ë¥¼ HTMLë¡œ í‘œì‹œ
            const cacheInfoHtml = `
                <div style="background: #f8f9ff; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    <h3 style="color: #667eea; margin: 0 0 15px 0;">ğŸ“· ì´ë¯¸ì§€ ìºì‹œ ì •ë³´</h3>
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold; color: #333;">ì´ ì €ì¥ëœ ì´ë¯¸ì§€:</span>
                            <span style="color: #667eea; font-weight: bold; font-size: 18px;">${imageCount}ê°œ</span>
                        </div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                        <div style="font-weight: bold; color: #333; margin-bottom: 10px;">ì´ë¯¸ì§€ ëª©ë¡:</div>
                        ${Object.entries(imageMap).slice(0, 10).map(([key, value]) => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee;">
                                <span style="color: #666; font-size: 14px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${key}</span>
                                <a href="${value}" target="_blank" style="color: #667eea; text-decoration: none; font-size: 12px;">ğŸ”— ë³´ê¸°</a>
                            </div>
                        `).join('')}
                        ${imageCount > 10 ? `<div style="text-align: center; color: #999; font-size: 12px; margin-top: 10px;">... ì™¸ ${imageCount - 10}ê°œ ë”</div>` : ''}
                    </div>
                    <div style="background: #e8f4fd; padding: 10px; border-radius: 8px; margin-top: 15px;">
                        <div style="font-size: 12px; color: #0066cc; line-height: 1.4;">
                            ğŸ’¡ <strong>ì´ë¯¸ì§€ ìºì‹œ í™œìš©ë²•:</strong><br>
                            â€¢ "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸" ì²´í¬ë°•ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ ìºì‹œëœ ì´ë¯¸ì§€ë“¤ì„ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤<br>
                            â€¢ ê°™ì€ ì´ë¯¸ì§€ë¥¼ í¬í•¨í•œ ìƒí’ˆë“¤ì„ ë¹ ë¥´ê²Œ ë³€í™˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                            â€¢ ìºì‹œë¥¼ ì‚­ì œí•˜ë©´ ë‹¤ì‹œ ì´ë¯¸ì§€ ì—…ë¡œë“œê°€ í•„ìš”í•©ë‹ˆë‹¤
                        </div>
                    </div>
                </div>
            `;
            
            const alertDiv = document.getElementById('alert');
            alertDiv.innerHTML = cacheInfoHtml;
            alertDiv.className = 'alert info';
            alertDiv.style.display = 'block';
            
            // 10ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 10000);
        }

        function checkImageCacheStatus() {
            const savedImages = localStorage.getItem('imgbbImageMap');
            const imageCount = savedImages ? Object.keys(JSON.parse(savedImages)).length : 0;
            
            // ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¥¸ ì•ˆë‚´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
            const skipImageUpload = document.getElementById('skipImageUpload').checked;
            const infoDiv = document.querySelector('.settings > div:last-child');
            
            if (skipImageUpload) {
                if (imageCount > 0) {
                    infoDiv.innerHTML = `
                        <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 5px; font-size: 12px; color: #0066cc;">
                            ğŸ’¡ <strong>ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸ ëª¨ë“œ (${imageCount}ê°œ ì´ë¯¸ì§€ ìºì‹œ ì‚¬ìš©)</strong><br>
                            â€¢ ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ì´ë¯¸ì§€BBì—ì„œ ì°¾ì•„ì„œ ë§¤ì¹­í•©ë‹ˆë‹¤<br>
                            â€¢ ìƒˆë¡œìš´ ì´ë¯¸ì§€ ì—…ë¡œë“œëŠ” í•˜ì§€ ì•Šì•„ ë³€í™˜ ì†ë„ê°€ ë¹ ë¦…ë‹ˆë‹¤<br>
                            â€¢ ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ëŠ” ì›ë³¸ URLì„ ì‚¬ìš©í•©ë‹ˆë‹¤<br>
                            â€¢ GPT ì‚¬ìš© ì‹œ í…ìŠ¤íŠ¸ ê°œì„ ë§Œ ì§„í–‰ë©ë‹ˆë‹¤
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 12px; color: #856404;">
                            âš ï¸ <strong>ì´ë¯¸ì§€ ìºì‹œê°€ ì—†ìŠµë‹ˆë‹¤</strong><br>
                            â€¢ ì €ì¥ëœ ì´ë¯¸ì§€ê°€ ì—†ì–´ ëª¨ë“  ì´ë¯¸ì§€ê°€ ì›ë³¸ URLì„ ì‚¬ìš©í•©ë‹ˆë‹¤<br>
                            â€¢ ì•ˆì •ì ì¸ ì´ë¯¸ì§€ ë§í¬ë¥¼ ìœ„í•´ "ì´ë¯¸ì§€ ì—…ë¡œë“œ ì œì™¸" ì²´í¬ë¥¼ í•´ì œí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤<br>
                            â€¢ ì²« ë²ˆì§¸ ë³€í™˜ ì‹œì—ëŠ” ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ì‹¤í–‰í•˜ì—¬ ìºì‹œë¥¼ ë§Œë“œì„¸ìš”
                        </div>
                    `;
                }
            } else {
                infoDiv.innerHTML = `
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 12px; color: #856404;">
                        ğŸ’¡ <strong>GPT ì‚¬ìš© ì‹œ ì£¼ì˜ì‚¬í•­:</strong><br>
                        â€¢ ìƒí’ˆëª…, ê¸°ë³¸ì„¤ëª…, ìƒí’ˆì„¤ëª…ì´ ëª¨ë‘ ê°œì„ ë˜ì–´ API ë¹„ìš©ì´ ì¦ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                        â€¢ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œ ì¶”ê°€ ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤ (ìƒí’ˆë‹¹ ì•½ 2-5ì´ˆ)<br>
                        â€¢ ë¯¸ë¦¬ë³´ê¸°ì—ì„œë„ ì²˜ìŒ 3ê°œ ìƒí’ˆì— ëŒ€í•´ GPT APIê°€ í˜¸ì¶œë©ë‹ˆë‹¤<br>
                        â€¢ ì˜¤ë¥˜ ë°œìƒ ì‹œ "API Key í…ŒìŠ¤íŠ¸"ë¥¼ ëˆŒëŸ¬ í•´ê²° ë°©ë²•ì„ í™•ì¸í•˜ì„¸ìš”
                    </div>
                `;
            }
        }

        function forceDownload() {
            if (!lastExcelData || !lastFilename) {
                showAlert('ë‹¤ìš´ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë³€í™˜ì„ ì§„í–‰í•˜ì„¸ìš”.', 'error');
                return;
            }

            try {
                const worksheet = XLSX.utils.aoa_to_sheet(lastExcelData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "ìƒí’ˆëª©ë¡");
                
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelBuffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = lastFilename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                }, 100);
                
                showAlert(`âœ… ${lastFilename} ê°•ì œ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`, 'success');
                
            } catch (error) {
                showAlert('âŒ ê°•ì œ ë‹¤ìš´ë¡œë“œë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                console.error('ê°•ì œ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
    </script>
</body>
</html>
